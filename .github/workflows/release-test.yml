# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: Swift

on:
  release:
    types:
      - created

jobs:
  test-ios:
    name: Test on iOS Simulator
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: List available iOS simulators
        id: find-simulator
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available --json | jq -r '.devices | to_entries[] | select(.key | contains("iOS")) | .value[] | "\(.name) (\(.udid))"'
          
          # Get the first available iPhone simulator
          SIMULATOR_NAME=$(xcrun simctl list devices available --json | jq -r '[.devices | to_entries[] | select(.key | contains("iOS")) | .value[] | select(.name | startswith("iPhone"))] | first | .name')
          
          echo "Selected simulator: $SIMULATOR_NAME"
          echo "simulator_name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT

      - name: Run unit tests on iOS Simulator
        run: |
          # Use the dynamically discovered iOS Simulator
          IOS_DESTINATION="platform=iOS Simulator,name=${{ steps.find-simulator.outputs.simulator_name }},OS=latest"
          
          echo "Using destination: $IOS_DESTINATION"
          
          PACKAGE_SCHEME="HarmonicClientSideAdTracking"

          set -o pipefail && env NSUnbufferedIO=YES xcodebuild test \
            -scheme "$PACKAGE_SCHEME" \
            -destination "$IOS_DESTINATION" \
            | xcpretty
